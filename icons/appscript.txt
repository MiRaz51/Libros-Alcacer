function doGet(e) { return handleRequest('GET', e); }
function doPost(e) { return handleRequest('POST', e); }

function handleRequest(method, e) {
  try {
    var params = method === 'GET' ? e.parameter : JSON.parse(e.postData.contents || '{}');
    var action = (params.action || '').toLowerCase();
    var result;
    switch (action) {
      case 'list_libros': result = listLibros(params); break;
      case 'search_libros': result = searchLibros(params); break;
      case 'get_libro': result = getLibro(params.id); break;
      case 'create_libro': result = createLibro(params); break;
      case 'update_libro': result = updateLibro(params); break;
      case 'delete_libro': result = deleteLibro(params.id); break;
      case 'catalogos': result = getCatalogos(); break;
      case 'catalogos_filtrados': result = getCatalogosFiltrados(params); break;
      case 'registrar_prestamo': result = registrarPrestamo(params); break;
      case 'registrar_devolucion': result = registrarDevolucion(params); break;
      default: throw new Error('Accion desconocida');
    }
    return json(result);
  } catch (err) {
    return json({ error: true, message: err.message });
  }
}

function json(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// Configuración
var CFG = {
  SHEET_ID: '1O5OibnL2w3wrZWFXj-PXHamQ4YvavL8L_tuNRVUP8OE',
  T_LIBROS: 'Libros',
  T_AUTORES: 'Autores',
  T_CATEGORIAS: 'Categorias',
  T_CAJAS: 'Cajas'
};

// Utilidades de hoja
function ss() { return SpreadsheetApp.openById(CFG.SHEET_ID); }
function table(name) { var sh = ss().getSheetByName(name); if (!sh) throw new Error('No existe pestaña: '+name); return sh; }
function readAll(name) {
  var sh = table(name);
  var rng = sh.getDataRange().getValues();
  if (rng.length < 2) return [];
  var headersRaw = rng.shift().map(function(h){ return String(h||'').trim(); });
  var headers = headersRaw.map(function(h){ return normalizeKey(h); });
  return rng.filter(function(r){ return r.some(function(v){ return String(v).length; }); })
           .map(function(r){
             var o = toObj(headers, r);
             var est = pickEstado(headers, r);
             if (String(est).length) o.estado = est;
             return o;
           });
}
function toObj(headers, row) {
  var o = {};
  headers.forEach(function(h,i){ 
    var val = row[i];
    // Convertir fechas a string para mostrar tal cual
    if (val instanceof Date) {
      // Si es una fecha, extraer solo el año
      val = val.getFullYear();
    }
    o[h] = val; 
    // Alias: fechadepublicacion también se mapea como anio
    if (h === 'fechadepublicacion') {
      o['anio'] = val;
    }
  });
  return o;
}
function findHeaders(name) {
  var sh = table(name);
  var n = sh.getLastColumn();
  var raw = sh.getRange(1,1,1,n).getValues()[0].map(function(h){ return String(h||'').trim(); });
  return raw.map(function(h){ return normalizeKey(h); });
}
function writeRow(name, headers, obj) {
  var sh = table(name);
  var row = headers.map(function(h){ return obj[h]; });
  sh.appendRow(row);
}

// Normaliza una cabecera a una clave segura (minúsculas, sin acentos ni espacios ni signos)
function normalizeKey(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-zA-Z0-9]+/g,'')
    .toLowerCase();
}

// Normaliza texto para búsqueda (manteniendo separadores como espacios)
function normText(s){
  return String(s||'')
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,' ') // no letras/números a espacios
    .trim();
}

function titleKey(s){
  var t = normText(s);
  // quitar artículos al inicio
  t = t.replace(/^(el|la|los|las|the|un|una|unos|unas)\s+/, '');
  return t;
}

// Helpers para 'estado'
function pickEstado(headers, row){
  var idxEstado = headers.indexOf('estado');
  var idxPrestado = headers.indexOf('estadoprestado');
  if (idxEstado !== -1 && String(row[idxEstado]||'').length) return row[idxEstado];
  if (idxPrestado !== -1 && String(row[idxPrestado]||'').length) return row[idxPrestado];
  if (row.length > 31 && String(row[31]||'').length) return row[31]; // AF
  return '';
}

// Obtener categoría desde cabecera normalizada 'categoria' o, en su defecto, desde la columna AC (índice 28)
function pickCategoria(headers, row){
  var idx = headers.indexOf('categoria');
  if (idx !== -1 && String(row[idx]||'').length) return row[idx];
  if (row.length > 28 && String(row[28]||'').length) return row[28]; // AC
  return '';
}

// Obtener caja desde cabecera 'caja' o columna AD (índice 29)
function pickCaja(headers, row){
  var idx = headers.indexOf('caja');
  if (idx !== -1 && String(row[idx]||'').length) return row[idx];
  if (row.length > 29 && String(row[29]||'').length) return row[29]; // AD
  return '';
}

// Asegura que exista la columna 'id' y que todas las filas tengan un id
function ensureIdColumn(){
  var sh = table(CFG.T_LIBROS);
  var headers = findHeaders(CFG.T_LIBROS); // normalizadas
  var idIdx = headers.indexOf('id');
  var idCol;
  if (idIdx === -1){
    idCol = sh.getLastColumn() + 1;
    sh.getRange(1, idCol).setValue('id');
    headers.push('id');
  } else {
    idCol = idIdx + 1;
  }
  var lastRow = sh.getLastRow();
  if (lastRow < 2) return; // no data rows
  var n = lastRow - 1;
  var rng = sh.getRange(2, idCol, n, 1);
  var vals = rng.getValues();
  var dirty = false;
  for (var i=0; i<vals.length; i++){
    if (!String(vals[i][0]||'').trim()){
      vals[i][0] = Utilities.getUuid();
      dirty = true;
    }
  }
  if (dirty) rng.setValues(vals);
}

// Acciones Libros
function listLibros(params){
  ensureIdColumn();
  var items = readAll(CFG.T_LIBROS);
  items.sort(function(a,b){ return normText(a.titulo).localeCompare(normText(b.titulo)); });
  var out = items.map(function(x){ return {
    id: x.id,
    titulo: x.titulo,
    autor: x.autor,
    categoria: x.categoria,
    caja: x.caja,
    estado: x.estado
  };});
  return { items: out };
}

function searchLibros(p){
  var q = normText(p && p.q ? p.q : '');
  var cat = normText(p && p.cat ? p.cat : '');
  var cajaF = normText(p && p.caja ? p.caja : '');
  var estadoF = normText(p && p.estado ? p.estado : '');
  
  ensureIdColumn();
  var sh = table(CFG.T_LIBROS);
  var rng = sh.getDataRange().getValues();
  if (rng.length < 2) return { items: [] };
  
  var headers = rng.shift().map(function(h){ return normalizeKey(String(h||'').trim()); });
  
  // Filtrar en un solo paso combinando todas las condiciones
  var filtered = rng.filter(function(row){
    // Filtro por título (búsqueda parcial)
    if (q) {
      var titulo = normText(row[0]);
      if (!titulo) return false;
      if (titulo.indexOf(q) === -1) return false;
    }
    // Filtro por categoría
    if (cat && normText(pickCategoria(headers, row)) !== cat) return false;
    // Filtro por caja
    if (cajaF && normText(pickCaja(headers, row)) !== cajaF) return false;
    // Filtro por estado
    if (estadoF && normText(pickEstado(headers, row)) !== estadoF) return false;
    // Verificar que la fila tenga datos
    return row.some(function(v){ return String(v).length; });
  });
  
  // Mapear y ordenar
  var items = filtered.map(function(row){
    var o = toObj(headers, row);
    o.estado = pickEstado(headers, row);
    o.categoria = pickCategoria(headers, row);
    o.caja = pickCaja(headers, row);
    return {
      id: o.id,
      titulo: o.titulo,
      autor: o.autor,
      categoria: o.categoria,
      caja: o.caja,
      estado: o.estado
    };
  });
  
  items.sort(function(a,b){ return normText(a.titulo).localeCompare(normText(b.titulo)); });
  return { items: items };
}

function getLibro(id){
  if (!id) throw new Error('id requerido');
  ensureIdColumn();
  var items = readAll(CFG.T_LIBROS);
  var f = items.find(function(x){ return String(x.id) === String(id); });
  if(!f) throw new Error('No encontrado');
  return f;
}

function createLibro(p){
  var headers = findHeaders(CFG.T_LIBROS);
  if (headers.length === 0) throw new Error('La pestaña Libros no tiene cabeceras');
  if(!p.titulo) throw new Error('titulo requerido');
  var now = new Date();
  var obj = {
    id: Utilities.getUuid(),
    titulo: p.titulo||'',
    autor: p.autor||'',
    editorial: p.editorial||'',
    anio: Number(p.anio)||'',
    isbn: p.isbn||'',
    categoria: p.categoria||'',
    caja: p.caja||'',
    estado: p.estado||'Disponible',
    notas: p.notas||'',
    created_at: now,
    updated_at: now
  };
  writeRow(CFG.T_LIBROS, headers, obj);
  CacheService.getScriptCache().remove('catalogos'); // Invalidar caché
  return obj;
}

function updateLibro(p){
  if(!p.id) throw new Error('id requerido');
  var sh = table(CFG.T_LIBROS);
  ensureIdColumn();
  var headers = findHeaders(CFG.T_LIBROS);
  var colMap = {}; headers.forEach(function(h,i){ colMap[h] = i+1; });
  var idCol = colMap['id']; if(!idCol) throw new Error('No hay columna id');
  var last = sh.getLastRow();
  for (var r=2; r<=last; r++){
    if (String(sh.getRange(r, idCol).getValue()) === String(p.id)){
      var now = new Date();
      ['titulo','autor','editorial','anio','isbn','categoria','caja','notas'].forEach(function(k){
        if (k in p && colMap[k]) sh.getRange(r, colMap[k]).setValue(p[k]);
      });
      // Manejo especial de estado: escribir en 'estadoprestado' si existe, luego 'estado', sino en AF
      if ('estado' in p){
        if (colMap['estadoprestado']) {
          sh.getRange(r, colMap['estadoprestado']).setValue(p.estado);
        } else if (colMap['estado']) {
          sh.getRange(r, colMap['estado']).setValue(p.estado);
        } else {
          // AF (col 32)
          sh.getRange(r, 32).setValue(p.estado);
        }
      }
      if (colMap['updated_at']) sh.getRange(r, colMap['updated_at']).setValue(now);
      CacheService.getScriptCache().remove('catalogos'); // Invalidar caché
      return getLibro(p.id);
    }
  }
  throw new Error('No encontrado');
}

function deleteLibro(id){
  if (!id) throw new Error('id requerido');
  var sh = table(CFG.T_LIBROS);
  ensureIdColumn();
  var headers = findHeaders(CFG.T_LIBROS);
  var idCol = headers.findIndex(function(h){ return h==='id'; }) + 1;
  if(!idCol) throw new Error('No hay columna id');
  var last = sh.getLastRow();
  for (var r=2; r<=last; r++){
    if (String(sh.getRange(r, idCol).getValue()) === String(id)){
      sh.deleteRow(r);
      CacheService.getScriptCache().remove('catalogos'); // Invalidar caché
      return { ok: true };
    }
  }
  throw new Error('No encontrado');
}

function getCatalogos(){
  var cache = CacheService.getScriptCache();
  var cached = cache.get('catalogos');
  if (cached) return JSON.parse(cached);
  
  var sh = table(CFG.T_LIBROS);
  var rng = sh.getDataRange().getValues();
  var cats = [];
  var cajas = [];
  var estados = [];
  if (rng.length >= 2){
    var headers = rng.shift().map(function(h){ return normalizeKey(String(h||'').trim()); });
    var seen = {}, seenCj = {}, seenEst = {};
    rng.forEach(function(row){
      var c = pickCategoria(headers, row);
      if (String(c).length){
        var key = normText(c);
        if (!seen[key]){ seen[key]=true; cats.push(c); }
      }
      var cj = pickCaja(headers, row);
      if (String(cj).length){
        var keyCj = normText(cj);
        if (!seenCj[keyCj]){ seenCj[keyCj]=true; cajas.push(cj); }
      }
      var est = pickEstado(headers, row);
      if (String(est).length){
        var keyEst = normText(est);
        if (!seenEst[keyEst]){ seenEst[keyEst]=true; estados.push(est); }
      }
    });
    cats.sort(function(a,b){ return normText(a).localeCompare(normText(b)); });
    cajas.sort(function(a,b){ return normText(a).localeCompare(normText(b)); });
    estados.sort(function(a,b){ return normText(a).localeCompare(normText(b)); });
  }
  var result = { categorias: cats, cajas: cajas, estados: estados };
  cache.put('catalogos', JSON.stringify(result), 300); // 5 minutos
  return result;
}

function getCatalogosFiltrados(p){
  var qcat = normText(p && p.cat ? p.cat : '');
  var qcaja = normText(p && p.caja ? p.caja : '');
  var qest = normText(p && p.estado ? p.estado : '');
  var sh = table(CFG.T_LIBROS);
  var rng = sh.getDataRange().getValues();
  if (rng.length < 2) return { categorias: [], cajas: [], estados: [] };
  var headers = rng.shift().map(function(h){ return normalizeKey(String(h||'').trim()); });
  var seenC = {}, seenCJ = {}, seenE = {};
  var cats = [], cajas = [], estados = [];
  rng.forEach(function(row){
    var cat = pickCategoria(headers, row);
    var caja = pickCaja(headers, row);
    var est = pickEstado(headers, row);
    // Aplicar filtros dados
    if (qcat && normText(String(cat||'')) !== qcat) return;
    if (qcaja && normText(String(caja||'')) !== qcaja) return;
    if (qest && normText(String(est||'')) !== qest) return;
    // Recolectar valores únicos
    if (String(cat||'').length){ var k1 = normText(cat); if (!seenC[k1]){ seenC[k1]=true; cats.push(cat); } }
    if (String(caja||'').length){ var k2 = normText(String(caja)); if (!seenCJ[k2]){ seenCJ[k2]=true; cajas.push(caja); } }
    if (String(est||'').length){ var k3 = normText(est); if (!seenE[k3]){ seenE[k3]=true; estados.push(est); } }
  });
  cats.sort(function(a,b){ return normText(a).localeCompare(normText(b)); });
  cajas.sort(function(a,b){ var na=Number(a), nb=Number(b); return (na-nb)||String(a).localeCompare(String(b)); });
  estados.sort(function(a,b){ return normText(a).localeCompare(normText(b)); });
  return { categorias: cats, cajas: cajas, estados: estados };
}

function registrarPrestamo(p){
  if(!p.id) throw new Error('id requerido');
  if(!p.prestadoa) throw new Error('prestadoa requerido');
  
  var sh = table(CFG.T_LIBROS);
  ensureIdColumn();
  var headers = findHeaders(CFG.T_LIBROS);
  var colMap = {}; headers.forEach(function(h,i){ colMap[h] = i+1; });
  var idCol = colMap['id']; if(!idCol) throw new Error('No hay columna id');
  var last = sh.getLastRow();
  
  for (var r=2; r<=last; r++){
    if (String(sh.getRange(r, idCol).getValue()) === String(p.id)){
      // Escribir SOLO en columna AE (columna 31) el nombre de la persona
      sh.getRange(r, 31).setValue(p.prestadoa);
      
      // NO modificar columna AF (32) porque tiene fórmula
      // La fórmula en AF se actualizará automáticamente
      
      CacheService.getScriptCache().remove('catalogos'); // Invalidar caché
      return { ok: true, message: 'Préstamo registrado' };
    }
  }
  throw new Error('Libro no encontrado');
}

function registrarDevolucion(p){
  if(!p.id) throw new Error('id requerido');
  
  var sh = table(CFG.T_LIBROS);
  ensureIdColumn();
  var headers = findHeaders(CFG.T_LIBROS);
  var colMap = {}; headers.forEach(function(h,i){ colMap[h] = i+1; });
  var idCol = colMap['id']; if(!idCol) throw new Error('No hay columna id');
  var last = sh.getLastRow();
  
  for (var r=2; r<=last; r++){
    if (String(sh.getRange(r, idCol).getValue()) === String(p.id)){
      // Limpiar columna AE (columna 31) - eliminar nombre de la persona
      sh.getRange(r, 31).setValue('');
      
      // NO modificar columna AF (32) porque tiene fórmula
      // La fórmula en AF se actualizará automáticamente a "Disponible"
      
      CacheService.getScriptCache().remove('catalogos'); // Invalidar caché
      return { ok: true, message: 'Devolución registrada' };
    }
  }
  throw new Error('Libro no encontrado');
}